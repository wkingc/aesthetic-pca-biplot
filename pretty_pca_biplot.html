<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>pretty_pca_biplot.utf8</title>

<script src="pretty_pca_biplot_files/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="pretty_pca_biplot_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="pretty_pca_biplot_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="pretty_pca_biplot_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="pretty_pca_biplot_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="pretty_pca_biplot_files/navigation-1.1/tabsets.js"></script>
<script src="pretty_pca_biplot_files/navigation-1.1/codefolding.js"></script>
<link href="pretty_pca_biplot_files/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="pretty_pca_biplot_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>



<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div class="fluid-row" id="header">

<div class="btn-group pull-right">
<button type="button" class="btn btn-default btn-xs dropdown-toggle" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>




</div>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>It is not an overstatement to say that the default output for a Principal Components Analysis (PCA) biplot in R is <i>gross</i>. The image below is the default biplot generated for the farm stress data discussed in detail <a href="https://www.waderstats.com/using-principal-components-analysis-pca-to-analyze-latino-stress-by-agricultural-season-and-occupation/" target="_blank">here</a>. This presentation will show you how to use the output from the <b>prcomp()</b> function with the <i>ggplot2</i> library to create a more aesthetically pleasing and informative biplot <span class="citation">(Wickham <a href="#ref-ggplot2" role="doc-biblioref">2016</a>)</span>.</p>
<p>Throughout, we will use the R programming language and assume the user is using Rstudio to compile their R markdown files into HTML <span class="citation">(R Core Team <a href="#ref-Rlang2020" role="doc-biblioref">2020</a>; RStudio Team <a href="#ref-Rstudio2020" role="doc-biblioref">2020</a>)</span>. If you want to follow along with the R markdown, it is downloadable <a href="https://waderstats.com/rstudio-files/pretty_pca_biplot/pretty_pca_biplot.Rmd" target="_blank">here</a>. The associated bibliography file is <a href="https://waderstats.com/rstudio-files/pretty_pca_biplot/pretty_pca_biplot.bib" target="_blank">here</a>. The data can be downloaded <a href="https://waderstats.com/rstudio-files/pretty_pca_biplot/data/farmstress.RData" target="_blank">here</a>.</p>
<p><img src="farmstressS1_default_biplot.png" /></p>
</div>
<div id="libraries" class="section level1">
<h1>Libraries</h1>
<p>The libraries <i>knitr</i>, <i>bookdown</i>, <i>kableExtra</i>, and <i>DT</i>, generate the HTML output <span class="citation">(Xie <a href="#ref-knitr" role="doc-biblioref">2019</a>, <a href="#ref-bookdown" role="doc-biblioref">2018</a>; Zhu <a href="#ref-kableExtra" role="doc-biblioref">2019</a>; Xie, Cheng, and Tan <a href="#ref-DT" role="doc-biblioref">2018</a>)</span>. The <i>ggplot2</i> package is used to generate the final biplot <span class="citation">(Wickham <a href="#ref-ggplot2" role="doc-biblioref">2016</a>)</span>.</p>
<pre class="r"><code>package_loader &lt;- function(x, ...) {
  if (x %in% rownames(installed.packages()) == FALSE) install.packages(x)
  library(x, ...)
}

packages &lt;- c(&quot;knitr&quot;, &quot;bookdown&quot;, &quot;kableExtra&quot;, &quot;DT&quot;, &quot;ggplot2&quot;)

invisible(sapply(X = packages, FUN = package_loader, character.only = TRUE))</code></pre>
</div>
<div id="data-setup" class="section level1">
<h1>Data Setup</h1>
<p>The data are loaded from a previously constructed R data set and then subset only to include observations from the thinning season when the farmworkers are most active. We also remove two columns where there is no variance in the answers of the participants.</p>
<pre class="r"><code># Load the data
load(&quot;data/farmstress.RData&quot;)

# Season when the farm workers are the most active.
farmstressS1 &lt;- na.omit(farmstress[which(farmstress$season == &quot;Thinning&quot;), ])

# There is no variance to quantify in these columns
farmstressS1 &lt;- farmstressS1[, (-1)*which(colnames(farmstressS1) == &quot;violence&quot;)]
farmstressS1 &lt;- farmstressS1[, (-1)*which(colnames(farmstressS1) == &quot;druguse&quot;)]

# Variable to hold the occupation (e.g. farmworker vs. non-farmworker)
farmstressS1Occupation &lt;- farmstressS1$occupation

# A dataframe that remove occupation and season so it contains only numeric values.
farmstressS1 &lt;- farmstressS1[, c(-1, -2)]</code></pre>
</div>
<div id="pca-analysis" class="section level1">
<h1>PCA Analysis</h1>
<p>The PCA code for farm stress data is shown below. Generally, any PCA’s first step is to scale the data so that each feature is comparable, followed by mean centering, shifting the data on their axes without altering any stochastic properties. In this specific case, but generally, not so, scaling isn’t necessary since each column is measured using the same Likert-type scale.</p>
<p>We use the <b>prcomp()</b> function to do the PCA and subsequently extract the loadings, scores matrix, and feature importance as measured by how much each of the variability each PC axis explains in the observed data.</p>
<pre class="r"><code># Make the features comparable by centering each column around it&#39;s mean.  Since the data are already on the same scale, we do not need to also divide by their respective variance (e.g., scale = FALSE).
farmstressS1 &lt;- scale(farmstressS1, center = TRUE, scale = FALSE)

# This function does all of the math to do the PC matrix factorization.
farmstressS1_pca &lt;- prcomp(farmstressS1, center = FALSE, scale. = FALSE, retx = TRUE)

# The loadings (e.g., correlations), scores (e.g., projections) matricies, and importance
farmstressS1_pca_loadings &lt;- farmstressS1_pca$rotation # Loadings Matrix
farmstressS1_pca_scores &lt;- predict(farmstressS1_pca) # Scores Matris
farmstressS1_pca_importance &lt;- summary(farmstressS1_pca)$importance # Explained Variance</code></pre>
</div>
<div id="pca-biplot" class="section level1">
<h1>PCA Biplot</h1>
<p>The PCA biplot goal is to plot the projections of the observed data onto the first two PC axes and how well each of the features from the original feature space load onto the new factorization. To that end, we can deconstruct the process into five steps:</p>
<ol style="list-style-type: decimal">
<li>Setup the data to be plotted.</li>
<li>Plot the scores.</li>
<li>Plot segments showing how well each feature loads onto the first two PCs.</li>
<li>Label the axes with the explained variance of the first two PCs.</li>
<li>Adjust the plot theme to make it more pretty!</li>
</ol>
<div id="setup-the-data" class="section level2">
<h2>Setup the Data</h2>
<p>The scale of the feature loadings is between zero and one because they are correlations. Therefore it would be best if the PC axes we want to plot are also on the same scale. We can achieve this by using a min-max feature scaling approach.</p>
<pre class="r"><code># The plot data includes occupation and the first two PC components.
plotDataScores &lt;- cbind(occupation = farmstressS1Occupation, as.data.frame(farmstressS1_pca_scores[, c(&quot;PC1&quot;, &quot;PC2&quot;)]))

# We want to use min-max feature scaling on the scores so they are between zero and one, the same as the loadings.
normalize &lt;- function(x) return ((x - min(x)) / (max(x) - min(x)))

plotDataScores[, &quot;PC1&quot;] &lt;- scale(normalize(plotDataScores[, &quot;PC1&quot;]), center = TRUE, scale = FALSE)
plotDataScores[, &quot;PC2&quot;] &lt;- scale(normalize(plotDataScores[, &quot;PC2&quot;]), center = TRUE, scale = FALSE)

plotDataLoadings &lt;- as.data.frame(farmstressS1_pca_loadings)</code></pre>
</div>
<div id="plot-the-scores" class="section level2">
<h2>Plot the Scores</h2>
<p>The first thing to do is plot the scores, and since we have a categorical occupation, color the points as such to see if there is any separation between the two groups. The default colors are not very nice, so we choose two different (yes, colorblind-friendly!) colors using the <b>scale_color_manual()</b> function.</p>
<pre class="r"><code>p1 &lt;- ggplot() + 
  geom_point(data = plotDataScores, mapping = aes(x = PC1, y = PC2, colour = occupation)) + 
  scale_color_manual(values = c(&quot;#8F57BA55&quot;, &quot;#57BA7D55&quot;))

p1</code></pre>
<p><img src="pretty_pca_biplot_files/figure-html/pcStressBiplot2-1.png" width="864" /></p>
</div>
</div>
<div id="plot-the-loadings" class="section level1">
<h1>Plot the Loadings</h1>
<p>To express the loadings in the two dimensional PC space, we plot arrows that are the same length as to how well each original feature loads onto the PC space as measure by their correlation.</p>
<pre class="r"><code>p2 &lt;- p1 + 
  geom_segment(data = plotDataLoadings, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow(length = unit(0.03, &quot;npc&quot;)), alpha = 0.2) + 
  geom_text(data = plotDataLoadings, mapping = aes(x = PC1, y = PC2, label = rownames(plotDataLoadings)), hjust = 1, vjust = -0.2, colour = &quot;darkred&quot;, size = 4, check_overlap = TRUE)</code></pre>
<div id="label-the-axes" class="section level2">
<h2>Label the Axes</h2>
<p>The X and Y labels can also contain information. In this case, we add the proportion of variance explained by the first two PCs, respectively.</p>
<pre class="r"><code>p3 &lt;- p2 + 
  xlab(paste(&quot;PC1 (&quot;, round(farmstressS1_pca_importance[&quot;Proportion of Variance&quot;, &quot;PC1&quot;]*100, 1),&quot;%)&quot;, sep = &quot;&quot;)) + 
  ylab(paste(&quot;PC2 (&quot;, round(farmstressS1_pca_importance[&quot;Proportion of Variance&quot;, &quot;PC2&quot;]*100, 1),&quot;%)&quot;, sep = &quot;&quot;))

p3</code></pre>
<p><img src="pretty_pca_biplot_files/figure-html/pcStressBiplot4-1.png" width="864" /></p>
</div>
<div id="update-the-theme" class="section level2">
<h2>Update the Theme</h2>
<p>We can make some finish touches by updating the basic theme to make the plot look nicer.</p>
<pre class="r"><code>p4 &lt;- p3 + 
  theme(axis.line = element_line(colour = &quot;black&quot;),
        panel.border = element_rect(colour = &quot;black&quot;, fill = NA, size = 1),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 50, hjust = 1),
        axis.title = element_text(size = 12),
        legend.title = element_blank(),
        legend.position = &quot;right&quot;,
        panel.grid = element_line(color = &quot;lightgray&quot;),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;))

p4</code></pre>
<p><img src="pretty_pca_biplot_files/figure-html/pcStressBiplot5-1.png" width="864" /></p>
</div>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 4.0.3 (2020-10-10)
## Platform: x86_64-pc-linux-gnu (64-bit)
## Running under: Ubuntu 20.04.1 LTS
## 
## Matrix products: default
## BLAS:   /usr/lib/x86_64-linux-gnu/blas/libblas.so.3.9.0
## LAPACK: /usr/lib/x86_64-linux-gnu/lapack/liblapack.so.3.9.0
## 
## locale:
##  [1] LC_CTYPE=C.UTF-8       LC_NUMERIC=C           LC_TIME=C.UTF-8       
##  [4] LC_COLLATE=C.UTF-8     LC_MONETARY=C.UTF-8    LC_MESSAGES=C.UTF-8   
##  [7] LC_PAPER=C.UTF-8       LC_NAME=C              LC_ADDRESS=C          
## [10] LC_TELEPHONE=C         LC_MEASUREMENT=C.UTF-8 LC_IDENTIFICATION=C   
## 
## attached base packages:
## [1] stats     graphics  grDevices datasets  utils     methods   base     
## 
## other attached packages:
## [1] ggplot2_3.3.2    DT_0.16          kableExtra_1.3.1 bookdown_0.21   
## [5] knitr_1.30      
## 
## loaded via a namespace (and not attached):
##  [1] compiler_4.0.3    pillar_1.4.7      tools_4.0.3       digest_0.6.27    
##  [5] evaluate_0.14     lifecycle_0.2.0   tibble_3.0.4      gtable_0.3.0     
##  [9] viridisLite_0.3.0 pkgconfig_2.0.3   rlang_0.4.9       rstudioapi_0.13  
## [13] yaml_2.2.1        xfun_0.19         withr_2.3.0       httr_1.4.2       
## [17] stringr_1.4.0     dplyr_1.0.2       xml2_1.3.2        generics_0.1.0   
## [21] htmlwidgets_1.5.3 vctrs_0.3.5       tidyselect_1.1.0  webshot_0.5.2    
## [25] grid_4.0.3        glue_1.4.2        R6_2.5.0          rmarkdown_2.6    
## [29] farver_2.0.3      purrr_0.3.4       magrittr_2.0.1    scales_1.1.1     
## [33] htmltools_0.5.0   ellipsis_0.3.1    rvest_0.3.6       colorspace_2.0-0 
## [37] renv_0.12.2       labeling_0.4.2    stringi_1.5.3     munsell_0.5.0    
## [41] crayon_1.3.4</code></pre>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<!-- This is needed to resize iframe content. Please ignore if duplicationg this R markdown file -->
<script type="text/javascript" src="https://www.waderstats.com/wp-includes/js/iframe-resizer/js/iframeResizer.contentWindow.min.js" defer></script>
<div id="refs" class="references">
<div id="ref-Rlang2020">
<p>R Core Team. 2020. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.</p>
</div>
<div id="ref-Rstudio2020">
<p>RStudio Team. 2020. <em>RStudio: Integrated Development Environment for R</em>. Boston, MA: RStudio, PBC. <a href="http://www.rstudio.com/">http://www.rstudio.com/</a>.</p>
</div>
<div id="ref-ggplot2">
<p>Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.</p>
</div>
<div id="ref-bookdown">
<p>Xie, Yihui. 2018. <em>Bookdown: Authoring Books and Technical Documents with R Markdown</em>. <a href="https://github.com/rstudio/bookdown">https://github.com/rstudio/bookdown</a>.</p>
</div>
<div id="ref-knitr">
<p>———. 2019. <em>Knitr: A General-Purpose Package for Dynamic Report Generation in R</em>. <a href="https://yihui.name/knitr/">https://yihui.name/knitr/</a>.</p>
</div>
<div id="ref-DT">
<p>Xie, Yihui, Joe Cheng, and Xianying Tan. 2018. <em>DT: A Wrapper of the Javascript Library ’Datatables’</em>. <a href="https://CRAN.R-project.org/package=DT">https://CRAN.R-project.org/package=DT</a>.</p>
</div>
<div id="ref-kableExtra">
<p>Zhu, Hao. 2019. <em>KableExtra: Construct Complex Table with ’Kable’ and Pipe Syntax</em>. <a href="https://CRAN.R-project.org/package=kableExtra">https://CRAN.R-project.org/package=kableExtra</a>.</p>
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "pretty_pca_biplot_files/mathjax-local/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
