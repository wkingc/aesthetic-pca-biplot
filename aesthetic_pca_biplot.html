<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>aesthetic_pca_biplot.knit</title>

<script src="aesthetic_pca_biplot_files/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="aesthetic_pca_biplot_files/bootstrap-3.3.5/css/bootstrap.min.css" rel="stylesheet" />
<script src="aesthetic_pca_biplot_files/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="aesthetic_pca_biplot_files/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="aesthetic_pca_biplot_files/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="aesthetic_pca_biplot_files/navigation-1.1/tabsets.js"></script>
<script src="aesthetic_pca_biplot_files/navigation-1.1/codefolding.js"></script>
<link href="aesthetic_pca_biplot_files/highlightjs-9.12.0/textmate.css" rel="stylesheet" />
<script src="aesthetic_pca_biplot_files/highlightjs-9.12.0/highlight.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>

<style type="text/css">code{white-space: pre;}</style>
<script type="text/javascript">
if (window.hljs) {
  hljs.configure({languages: []});
  hljs.initHighlightingOnLoad();
  if (document.readyState && document.readyState === "complete") {
    window.setTimeout(function() { hljs.initHighlighting(); }, 0);
  }
}
</script>





<style type="text/css">
/* for pandoc --citeproc since 2.11 */
div.csl-bib-body { }
div.csl-entry {
  clear: both;
  margin-bottom: 0em;
}
.hanging div.csl-entry {
  margin-left:2em;
  text-indent:-2em;
}
div.csl-left-margin {
  min-width:2em;
  float:left;
}
div.csl-right-inline {
  margin-left:2em;
  padding-left:1em;
}
div.csl-indent {
  margin-left: 2em;
}
</style>




<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>



<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->
<style type="text/css">
.code-folding-btn { margin-bottom: 4px; }
</style>




</head>

<body>


<div class="container-fluid main-container">




<div id="header">

<div class="btn-group pull-right float-right">
<button type="button" class="btn btn-default btn-xs btn-secondary btn-sm dropdown-toggle" data-toggle="dropdown" data-bs-toggle="dropdown" aria-haspopup="true" aria-expanded="false"><span>Code</span> <span class="caret"></span></button>
<ul class="dropdown-menu dropdown-menu-right" style="min-width: 50px;">
<li><a id="rmd-show-all-code" href="#">Show All Code</a></li>
<li><a id="rmd-hide-all-code" href="#">Hide All Code</a></li>
</ul>
</div>




</div>


<div id="introduction" class="section level1">
<h1>Introduction</h1>
<p>It is not an overstatement to say that the default output for a Principal Components Analysis (PCA) biplot using the <b>biplot()</b> function in R is <i>gross</i>. An example of how bad it can be without modification is shown below using the farmworker stress data (discussed in detail <a href="https://www.waderstats.com/using-principal-components-analysis-pca-to-analyze-latino-stress-by-agricultural-season-and-occupation/" target="_blank">here</a>).</p>
<p><img src="farmstressS1_default_biplot.png" /></p>
<p>This presentation will show how to use the output from the <b>prcomp()</b> function with the <i>ggplot2</i> library to create a more aesthetically pleasing and informative PCA biplot <span class="citation">(<a href="#ref-ggplot2">Wickham 2016</a>)</span>. Throughout, this presentation uses the R programming language and assumes the end user is taking advantage of RStudio IDE to compile their R markdown files into HTML <span class="citation">(<a href="#ref-Rlang2020">R Core Team 2020</a>; <a href="#ref-Rstudio2020">RStudio Team 2020</a>)</span>. All of the files needed to reproduce these results can be downloaded from the Git repository <code>git clone <span>https</span>://git.waderstats.com/aesthetic_pca_biplot/</code>.</p>
</div>
<div id="libraries" class="section level1">
<h1>Libraries</h1>
<p>The libraries <i>knitr</i>, <i>bookdown</i>, <i>kableExtra</i>, and <i>DT</i>, generate the HTML output <span class="citation">(<a href="#ref-knitr">Xie 2019</a>, <a href="#ref-bookdown">2018</a>; <a href="#ref-kableExtra">Zhu 2019</a>; <a href="#ref-DT">Xie, Cheng, and Tan 2018</a>)</span>. The <i>ggplot2</i> package is used to generate the final biplot <span class="citation">(<a href="#ref-ggplot2">Wickham 2016</a>)</span>.</p>
<pre class="r"><code>package_loader &lt;- function(x, ...) {
  if (x %in% rownames(installed.packages()) == FALSE) install.packages(x)
  library(x, ...)
}

packages &lt;- c(&quot;knitr&quot;, &quot;bookdown&quot;, &quot;kableExtra&quot;, &quot;DT&quot;, &quot;ggplot2&quot;)

invisible(sapply(X = packages, FUN = package_loader, character.only = TRUE))</code></pre>
</div>
<div id="data-setup" class="section level1">
<h1>Data Setup</h1>
<p>The data are loaded from a previously constructed R data set and then subset only to include observations from the thinning season when the farmworkers are most active. We also remove two columns where there is no variance in the answers of the participants.</p>
<pre class="r"><code># Load the data
load(&quot;data/farmstress.RData&quot;)

# Season when the farmworkers are the most active.
farmstressS1 &lt;- na.omit(farmstress[which(farmstress$season == &quot;Thinning&quot;), ])

# There is no variance to quantify in these columns
farmstressS1 &lt;- farmstressS1[, (-1)*which(colnames(farmstressS1) == &quot;violence&quot;)]
farmstressS1 &lt;- farmstressS1[, (-1)*which(colnames(farmstressS1) == &quot;druguse&quot;)]

# Variable to hold the occupation (e.g. farmworker vs. non-farmworker)
farmstressS1Occupation &lt;- farmstressS1$occupation

# A dataframe that removes occupation and season so it contains only numeric values.
farmstressS1 &lt;- farmstressS1[, c(-1, -2)]</code></pre>
</div>
<div id="pca-analysis" class="section level1">
<h1>PCA Analysis</h1>
<p>The PCA code for farm stress data is shown below. Generally, any PCA’s first step is to scale the data so that each feature is comparable, followed by mean centering, shifting the data on their axes without altering any stochastic properties. In this specific case, but generally, not so, scaling isn’t necessary since each column is measured using the same Likert-type scale.</p>
<p>We use the <b>prcomp()</b> function to do the PCA and subsequently extract the loadings, scores matrix, and feature importance as measured by how much each of the variability each PC axis explains in the observed data.</p>
<pre class="r"><code># Make the features comparable by centering each column around its mean.  Since the data are already on the same scale, we do not need to also divide by their respective variance (e.g., scale = FALSE).
farmstressS1 &lt;- scale(farmstressS1, center = TRUE, scale = FALSE)

# This function does all of the math to create the PC matrix factorization.
farmstressS1_pca &lt;- prcomp(farmstressS1, center = FALSE, scale. = FALSE, retx = TRUE)

# Pieces from the PCA used in the biplot.
farmstressS1_pca_loadings &lt;- farmstressS1_pca$rotation # Loadings Matrix
farmstressS1_pca_scores &lt;- predict(farmstressS1_pca) # Scores Matris
farmstressS1_pca_importance &lt;- summary(farmstressS1_pca)$importance # Explained Variance</code></pre>
</div>
<div id="pca-biplot" class="section level1">
<h1>PCA Biplot</h1>
<p>The PCA biplot goal is to plot the projections of the observed data onto the first two PC axes and how well each of the features from the original feature space load onto the new factorization. To that end, we can deconstruct the process into five steps:</p>
<ol style="list-style-type: decimal">
<li>Setup the data to be plotted.</li>
<li>Plot the scores.</li>
<li>Plot segments showing how well each feature loads onto the first two PCs.</li>
<li>Label the axes with the explained variance of the first two PCs.</li>
<li>Adjust the plot theme to make it more pretty!</li>
</ol>
<div id="setup-the-data" class="section level2">
<h2>Setup the Data</h2>
<p>The scale of the feature loadings is between zero and one because they are correlations. Therefore it would be best if the PC axes we want to plot are also on the same scale. We can achieve this by using a min-max feature scaling approach.</p>
<pre class="r"><code># The plot data includes occupation and the first two PC components.
plotDataScores &lt;- cbind(occupation = farmstressS1Occupation, as.data.frame(farmstressS1_pca_scores[, c(&quot;PC1&quot;, &quot;PC2&quot;)]))

# We want to use min-max feature scaling on the scores so they are between zero and one, the same as the loadings.
normalize &lt;- function(x) return ((x - min(x)) / (max(x) - min(x)))

plotDataScores[, &quot;PC1&quot;] &lt;- scale(normalize(plotDataScores[, &quot;PC1&quot;]), center = TRUE, scale = FALSE)
plotDataScores[, &quot;PC2&quot;] &lt;- scale(normalize(plotDataScores[, &quot;PC2&quot;]), center = TRUE, scale = FALSE)

plotDataLoadings &lt;- as.data.frame(farmstressS1_pca_loadings)</code></pre>
</div>
<div id="plot-the-scores" class="section level2">
<h2>Plot the Scores</h2>
<p>The first thing to do is plot the scores, and since we have a categorical occupation, color the points as such to see if there is any separation between the two groups. The default colors are not very nice, so we choose two different (yes, colorblind-friendly!) colors using the <b>scale_color_manual()</b> function.</p>
<pre class="r"><code>p1 &lt;- ggplot() + 
  geom_point(data = plotDataScores, mapping = aes(x = PC1, y = PC2, colour = occupation)) + 
  scale_color_manual(values = c(&quot;#8F57BA55&quot;, &quot;#57BA7D55&quot;))

p1</code></pre>
<p><img src="aesthetic_pca_biplot_files/figure-html/pcStressBiplot2-1.png" width="864" /></p>
</div>
</div>
<div id="plot-the-loadings" class="section level1">
<h1>Plot the Loadings</h1>
<p>To express the loadings in the two dimensional PC space, we plot arrows that are the same length as to how well each original feature loads onto the PC space as measure by their correlation.</p>
<pre class="r"><code>p2 &lt;- p1 + 
  geom_segment(data = plotDataLoadings, aes(x = 0, y = 0, xend = PC1, yend = PC2), arrow = arrow(length = unit(0.03, &quot;npc&quot;)), alpha = 0.2) + 
  geom_text(data = plotDataLoadings, mapping = aes(x = PC1, y = PC2, label = rownames(plotDataLoadings)), hjust = 1, vjust = -0.2, colour = &quot;darkred&quot;, size = 4, check_overlap = TRUE)

p2</code></pre>
<p><img src="aesthetic_pca_biplot_files/figure-html/pcStressBiplot3-1.png" width="864" /></p>
<div id="label-the-axes" class="section level2">
<h2>Label the Axes</h2>
<p>The X and Y labels can also contain information. In this case, we add the proportion of variance explained by the first two PCs, respectively.</p>
<pre class="r"><code>p3 &lt;- p2 + 
  xlab(paste(&quot;PC1 (&quot;, round(farmstressS1_pca_importance[&quot;Proportion of Variance&quot;, &quot;PC1&quot;]*100, 1),&quot;%)&quot;, sep = &quot;&quot;)) + 
  ylab(paste(&quot;PC2 (&quot;, round(farmstressS1_pca_importance[&quot;Proportion of Variance&quot;, &quot;PC2&quot;]*100, 1),&quot;%)&quot;, sep = &quot;&quot;))

p3</code></pre>
<p><img src="aesthetic_pca_biplot_files/figure-html/pcStressBiplot4-1.png" width="864" /></p>
</div>
<div id="update-the-theme" class="section level2">
<h2>Update the Theme</h2>
<p>We can make some finish touches by updating the basic theme to make the plot look nicer.</p>
<pre class="r"><code>p4 &lt;- p3 + 
  theme(axis.line = element_line(colour = &quot;black&quot;),
        panel.border = element_rect(colour = &quot;black&quot;, fill = NA, size = 1),
        axis.text = element_text(size = 12),
        axis.text.x = element_text(angle = 50, hjust = 1),
        axis.title = element_text(size = 12),
        legend.title = element_blank(),
        legend.position = &quot;right&quot;,
        panel.grid = element_line(color = &quot;lightgray&quot;),
        panel.background = element_rect(fill = &quot;white&quot;, colour = &quot;white&quot;))

p4</code></pre>
<p><img src="aesthetic_pca_biplot_files/figure-html/pcStressBiplot5-1.png" width="864" /></p>
</div>
</div>
<div id="session-info" class="section level1">
<h1>Session Info</h1>
<pre class="r"><code>sessionInfo()</code></pre>
<pre><code>## R version 4.4.1 (2024-06-14)
## Platform: aarch64-apple-darwin20
## Running under: macOS Sonoma 14.6.1
## 
## Matrix products: default
## BLAS:   /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRblas.0.dylib 
## LAPACK: /Library/Frameworks/R.framework/Versions/4.4-arm64/Resources/lib/libRlapack.dylib;  LAPACK version 3.12.0
## 
## locale:
## [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8
## 
## time zone: America/New_York
## tzcode source: internal
## 
## attached base packages:
## [1] stats     graphics  grDevices datasets  utils     methods   base     
## 
## other attached packages:
## [1] ggplot2_3.5.1    DT_0.33          kableExtra_1.4.0 bookdown_0.40   
## [5] knitr_1.48      
## 
## loaded via a namespace (and not attached):
##  [1] gtable_0.3.5      jsonlite_1.8.9    highr_0.11        compiler_4.4.1   
##  [5] renv_1.0.10       xml2_1.3.6        stringr_1.5.1     jquerylib_0.1.4  
##  [9] systemfonts_1.1.0 scales_1.3.0      yaml_2.3.10       fastmap_1.2.0    
## [13] R6_2.5.1          labeling_0.4.3    htmlwidgets_1.6.4 tibble_3.2.1     
## [17] munsell_0.5.1     svglite_2.1.3     bslib_0.8.0       pillar_1.9.0     
## [21] rlang_1.1.4       utf8_1.2.4        cachem_1.1.0      stringi_1.8.4    
## [25] xfun_0.48         sass_0.4.9        viridisLite_0.4.2 cli_3.6.3        
## [29] withr_3.0.1       magrittr_2.0.3    digest_0.6.37     grid_4.4.1       
## [33] rstudioapi_0.16.0 lifecycle_1.0.4   vctrs_0.6.5       evaluate_1.0.0   
## [37] glue_1.8.0        farver_2.1.2      fansi_1.0.6       colorspace_2.1-1 
## [41] rmarkdown_2.28    tools_4.4.1       pkgconfig_2.0.3   htmltools_0.5.8.1</code></pre>
</div>
<div id="references" class="section level1">
<h1>References</h1>
<!-- This is needed to resize iframe content. Please ignore if duplicationg this R markdown file -->
<script type="text/javascript" src="https://www.waderstats.com/wp-includes/js/iframe-resizer/js/iframeResizer.contentWindow.min.js" defer></script>
<div id="refs" class="references csl-bib-body hanging-indent" entry-spacing="0">
<div id="ref-Rlang2020" class="csl-entry">
R Core Team. 2020. <em>R: A Language and Environment for Statistical Computing</em>. Vienna, Austria: R Foundation for Statistical Computing. <a href="https://www.R-project.org/">https://www.R-project.org/</a>.
</div>
<div id="ref-Rstudio2020" class="csl-entry">
RStudio Team. 2020. <em>RStudio: Integrated Development Environment for r</em>. Boston, MA: RStudio, PBC. <a href="http://www.rstudio.com/">http://www.rstudio.com/</a>.
</div>
<div id="ref-ggplot2" class="csl-entry">
Wickham, Hadley. 2016. <em>Ggplot2: Elegant Graphics for Data Analysis</em>. Springer-Verlag New York. <a href="https://ggplot2.tidyverse.org">https://ggplot2.tidyverse.org</a>.
</div>
<div id="ref-bookdown" class="csl-entry">
Xie, Yihui. 2018. <em>Bookdown: Authoring Books and Technical Documents with r Markdown</em>. <a href="https://github.com/rstudio/bookdown">https://github.com/rstudio/bookdown</a>.
</div>
<div id="ref-knitr" class="csl-entry">
———. 2019. <em>Knitr: A General-Purpose Package for Dynamic Report Generation in r</em>. <a href="https://yihui.name/knitr/">https://yihui.name/knitr/</a>.
</div>
<div id="ref-DT" class="csl-entry">
Xie, Yihui, Joe Cheng, and Xianying Tan. 2018. <em>DT: A Wrapper of the JavaScript Library ’DataTables’</em>. <a href="https://CRAN.R-project.org/package=DT">https://CRAN.R-project.org/package=DT</a>.
</div>
<div id="ref-kableExtra" class="csl-entry">
Zhu, Hao. 2019. <em>kableExtra: Construct Complex Table with ’Kable’ and Pipe Syntax</em>. <a href="https://CRAN.R-project.org/package=kableExtra">https://CRAN.R-project.org/package=kableExtra</a>.
</div>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->
<script>
$(document).ready(function () {
  window.initializeCodeFolding("show" === "show");
});
</script>


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "aesthetic_pca_biplot_files/mathjax-local/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
